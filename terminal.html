<!DOCTYPE html>
<!--
To change this license header, choose License Headers in Project Properties.
To change this template file, choose Tools | Templates
and open the template in the editor.
-->
<html>
    <head>
        <title>TODO supply a title</title>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        
        <script type="text/javascript" src="js/libs/jquery/jquery.js"></script>       
        
        <script type="text/javascript">
            function postXML(xmlString,url,action)
            {       
                $.ajax({
                    type: "POST",
                    url: url,
                    data: xmlString,
                    contentType: "text/xml",
                    cache: false,
                    dataType: "xml",
                    success: function(data, textStatus, jqXHR){processResponse({xml: data, textStatus: textStatus, action: action});},
                    error:function(jqXHR, textStatus, errorThrown){errorAlert(jqXHR,textStatus,errorThrown,action);}
                });              
            }
            
            function processResponse(parameters) 
            {                
                var xml = parameters.xml;
                var textStatus = parameters.textStatus;
                var action = parameters.action;
                var dataReturned = 0;
                
                //var xmlobj = jQuery.parseXML(data);
                var xmlobj = $(xml).find('serviceResponse');

                if(action === 'login')
                {                    
                    if(xmlobj.find("status").text() === 'Success')
                    {
                        $('#sessionid').val(xmlobj.find("session_id").text());

                        $('#logindiv').css('display','none');
                        $('#homediv').css('display','inline');

                    }else{
                        alert('Login failed:'+xmlobj.find("error").text());
                    }
                }
                
                if(action === 'allocate_voucher')
                {
                    if(xmlobj.find("status").text() === 'Success')
                    {                        
                        $('#soldVoucherNumber').val(xmlobj.find("voucher_number").text());                        
                    }else{
                        alert('Error:'+xmlobj.find("error").text());
                    }
                }
                
                if(action === 'redeem_laybye')
                {
                    if(xmlobj.find("status").text() === 'Success')
                    {                        
                        alert('Voucher redeemed');                        
                    }else{
                        alert('Error:'+xmlobj.find("error").text());
                    }
                }
            }
            
            function errorAlert(jqXHR,textStatus,errorThrown,dataObject)
            {                          
                if(errorThrown !== '')
                {
                    alert('[AJAX ERROR]: '+errorThrown);
                }
            }
            
            // /////////////////////////////////////////////////////////////////
            function login()
            {
                var user_pass = $('#user_pass').val();
                var errorTxt = '';
                
                if (user_pass.length === 0 && errorTxt === '')
                {
                    errorTxt = 'Please enter a terminal pin';
                }

                if (user_pass.length !== 4 && errorTxt === '')
                {
                    errorTxt = 'Pin must be four characters';
                }

                if(!isAlphaNumeric(user_pass) && errorTxt === '')
                {
                    errorTxt = 'Pin must be alphanumeric';
                }
                
                if(errorTxt !== '')
                {
                    alert(errorTxt);
                }else{
                    if(user_pass === '1234')
                    {
                        getSession();
                    }else{
                        alert('Invalid login credentials');
                    }
                }
            }
            function showSellVoucher()
            {
                $('#homediv').css('display','none');             
                $('#redeemlaybyediv').css('display','none');  
                $('#sellvoucherdiv').css('display','inline');
            }
            
            function showHome()
            {                             
                $('#sellvoucherdiv').css('display','none');
                $('#redeemlaybyediv').css('display','none');  
                $('#homediv').css('display','inline');  
            }
            
            function showRedeemLayBye()
            {
                $('#sellvoucherdiv').css('display','none');
                $('#homediv').css('display','none');  
                $('#redeemlaybyediv').css('display','inline');  
            }
            ///////////////////////////////////////////////////////
            function getSession()
            {                
                var xmlString ="<?xml version='1.0'?><serviceRequest><action>login</action><login_str>tha001testcompany</login_str><password>thapelo1234</password></serviceRequest>";
                postXML(xmlString,'http://localhost/VBA_GlocellWallet/index.php','login');
            }
            
            function getVoucher(value)
            {
                var xmlString ="<?xml version='1.0'?><serviceRequest><action>allocate_voucher</action><session_id>"+$('#sessionid').val()+"</session_id><product>"+value+"</product></serviceRequest>";
                postXML(xmlString,'http://localhost/VBA_GlocellWallet/index.php','allocate_voucher');
            }
            
            function redeemLayBye()
            {
                var laybyevouchernumber = $('#laybyevouchernumber').val();
                var laybyevalue = $('#laybyevalue').val();
                var errorTxt = '';
                
                if (laybyevouchernumber.length === 0 && errorTxt === '')
                {
                    errorTxt = 'Please enter a voucher number';
                }
                
                if (laybyevouchernumber.length !== 9 && errorTxt === '')
                {
                    errorTxt = 'Invalid voucher number';
                }
                
                if (!$.isNumeric(laybyevouchernumber) && errorTxt === '')
                {
                    errorTxt = 'Invalid voucher number';
                }
                
                if (laybyevalue.length === 0 && errorTxt === '')
                {
                    errorTxt = 'Please enter a value to redeem';
                }
                
                if (!$.isNumeric(laybyevalue) && errorTxt === '')
                {
                    errorTxt = 'Invalid value';
                }
                
                if(errorTxt != '')
                {
                    alert(errorTxt);
                }else{
                    var xmlString ="<?xml version='1.0'?><serviceRequest><action>redeem_laybye</action><session_id>"+$('#sessionid').val()+"</session_id><value>"+laybyevalue+"</value><voucher_number>"+laybyevouchernumber+"</voucher_number></serviceRequest>";
                    postXML(xmlString,'http://localhost/VBA_GlocellWallet/index.php','redeem_laybye');
                }
            }
            
            function isAlphaNumeric(str) {
                var code, i, len;

                for (i = 0, len = str.length; i < len; i++) {
                  code = str.charCodeAt(i);
                  if (!(code > 47 && code < 58) && // numeric (0-9)
                      !(code > 64 && code < 91) && // upper alpha (A-Z)
                      !(code > 96 && code < 123)) { // lower alpha (a-z)
                    return false;
                  }
                }
                return true;
            }
        </script>
    </head>
    <body>
        <input type="hidden" name="sessionid" id="sessionid"/>
        <input type="hidden" name="userid" id="userid" value="123"/>
        
        <div id="logindiv">
            <input type="text" id="user_pass" />
            <br>
            <input type="button" value="Login" onclick="login()"/>
        </div>
        
        <div id="homediv" style="display:none">
            <input type="button" value="Sell Voucher" onclick="showSellVoucher()"/>
            <br>
            <input type="button" value="Redeem lay-bye voucher" onclick="showRedeemLayBye()"/>
        </div>
        
        <div id="sellvoucherdiv" style="display:none">
            <input type="button" value="Home" onclick="showHome()"/>
            <br>
            Please choose a product
            <br>
            <input type="button" value="Buy R10" onclick="getVoucher('PGC010');"/>
            <br>
            <input type="button" value="Buy R20" onclick="getVoucher('PGC020');"/>
            <br>
            <input type="button" value="Buy R50" onclick="getVoucher('PGC050');"/>
            <br>
            <input type="button" value="Buy R100" onclick="getVoucher('PGC100');"/>
            <br>
            <input type="text" id="soldVoucherNumber" readonly=""/>
        </div>
        
        <div id="redeemlaybyediv" style="">
            Please enter a voucher number
            <br>
            <input type="text" id="laybyevouchernumber"/>
            <br>
            Value (R)
            <br>
            <input type="text" id="laybyevalue"/>
            <br>
            <input type="button" value="Redeem" onclick="redeemLayBye()"/>
        </div>
        
    </body>
</html>
